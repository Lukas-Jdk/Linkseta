generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id         String  @id @default(cuid())
  email      String  @unique
  supabaseId String? @unique

  name  String?
  phone String?
  role  UserRole @default(USER)

  avatarUrl String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  profile     ProviderProfile?
  services    ServiceListing[]
  jobListings JobListing[]
  auditLogs   AuditLog[]       @relation("UserAuditLogs")
}

enum UserRole {
  USER
  ADMIN
}

model ProviderProfile {
  id          String  @id @default(cuid())
  userId      String  @unique
  companyName String?
  description String?
  website     String?
  isApproved  Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])
}

model ServiceListing {
  id          String   @id @default(cuid())
  userId      String
  title       String
  slug        String   @unique
  description String
  priceFrom   Int?
  priceTo     Int?
  isActive    Boolean  @default(true)
  highlighted Boolean  @default(false)
  highlights  String[] @default([])
  imageUrl    String?
  imagePath   String?
  cityId      String?
  categoryId  String?
  planId      String?

  deletedAt DateTime? // 

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user     User      @relation(fields: [userId], references: [id])
  city     City?     @relation(fields: [cityId], references: [id])
  category Category? @relation(fields: [categoryId], references: [id])
  plan     Plan?     @relation(fields: [planId], references: [id])

  @@index([isActive, cityId, categoryId])
  @@index([createdAt])
  @@index([deletedAt])
}

model JobListing {
  id             String  @id @default(cuid())
  userId         String
  title          String
  slug           String  @unique
  description    String
  employmentType String?
  salaryFrom     Int?
  salaryTo       Int?
  isActive       Boolean @default(true)
  remote         Boolean @default(false)

  cityId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User  @relation(fields: [userId], references: [id])
  city City? @relation(fields: [cityId], references: [id])

  @@index([isActive, cityId])
  @@index([createdAt])
}

model City {
  id   String @id @default(cuid())
  name String
  slug String @unique

  services         ServiceListing[]
  jobs             JobListing[]
  providerRequests ProviderRequest[]
}

model Category {
  id   String       @id @default(cuid())
  name String
  slug String       @unique
  type CategoryType @default(SERVICE)

  services         ServiceListing[]
  providerRequests ProviderRequest[]
}

enum CategoryType {
  SERVICE
  JOB
}

model Plan {
  id          String     @id @default(cuid())
  name        String
  slug        String     @unique
  priceNok    Int
  period      PlanPeriod @default(MONTHLY)
  maxListings Int?
  highlight   Boolean    @default(false)

  services ServiceListing[]
}

enum PlanPeriod {
  MONTHLY
  YEARLY
}

enum ProviderRequestStatus {
  PENDING
  APPROVED
  REJECTED
}

model ProviderRequest {
  id         String                @id @default(cuid())
  name       String
  email      String
  phone      String?
  cityId     String?
  categoryId String?
  message    String?
  status     ProviderRequestStatus @default(PENDING)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  city     City?     @relation(fields: [cityId], references: [id])
  category Category? @relation(fields: [categoryId], references: [id])
}

model AuditLog {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  // kas atliko veiksmą (gali būti null jei anon)
  userId String?
  user   User?   @relation("UserAuditLogs", fields: [userId], references: [id])

  // ką padarė
  action   String // pvz. "SERVICE_CREATE", "SERVICE_UPDATE", "SERVICE_DELETE"
  entity   String // pvz. "ServiceListing", "ProviderRequest"
  entityId String?

  // kontekstas
  ip        String?
  userAgent String?

  // papildoma info (pvz. kas pasikeitė, senas/new)
  metadata Json?

  @@index([createdAt])
  @@index([userId])
  @@index([entity, entityId])
}
